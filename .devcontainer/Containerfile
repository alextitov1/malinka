FROM almalinux:9

ARG PYTHON_VER=3.12


COPY ansible-galaxy-requirements.yaml /tmp/ansible-galaxy-requirements.yaml
COPY pip-requirements.txt /tmp/pip-requirements.txt

RUN dnf -y update && \
    dnf -y install \
        git \
        which \
        zsh \
        sshpass \
        python${PYTHON_VER} \
        util-linux-user && \
    dnf clean all && \

    python${PYTHON_VER} -m ensurepip && \
    python${PYTHON_VER} -m pip install --upgrade pip && \

    # install extra python packages
    python${PYTHON_VER} -m pip install -r /tmp/pip-requirements.txt && \
    rm -f /tmp/pip-requirements.txt && \

    # installing ansible collections and roles
    ansible-galaxy role install -r /tmp/ansible-galaxy-requirements.yaml && \
    ansible-galaxy collection install -r /tmp/ansible-galaxy-requirements.yaml && \
    rm -f /tmp/ansible-galaxy-requirements.yaml && \

    # generating a ssh key pair to access managed nodes from a control node
    /bin/ssh-keygen -q -t rsa -N '' -f /root/.ssh/id_rsa && \

    # oh-my-zsh installation
    chsh root -s $(which zsh) && \
    git clone https://github.com/ohmyzsh/ohmyzsh.git /root/ohmyzsh && \
    /root/ohmyzsh/tools/install.sh && \
    rm -rf /root/ohmyzsh && \

    # Onepass cli
    rpm --import https://downloads.1password.com/linux/keys/1password.asc && \
    sh -c 'echo -e "[1password]\nname=1Password Stable Channel\nbaseurl=https://downloads.1password.com/linux/rpm/stable/\$basearch\nenabled=1\ngpgcheck=1\nrepo_gpgcheck=1\ngpgkey=\"https://downloads.1password.com/linux/keys/1password.asc\"" > /etc/yum.repos.d/1password.repo' && \
    dnf check-update -y 1password-cli && \
    dnf -y install 1password-cli
# RUN echo -e "Host *\n\tStrictHostKeyChecking no\n" >> /etc/ssh/ssh_config

